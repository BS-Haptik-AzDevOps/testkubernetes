trigger:
  batch: true
  paths:
    include:
      - testkubernetes/azure-pipelines.deploy.yaml
  branches:
    include:
      - main

variables:
  helmVersion: 3.0.2
  containerRepository: spinnaker
  containerRegistry: spinkube.azurecr.io
  azuresubscription: BS-Haptik-Test-SVC-Connection
  rggroup: Spinnaker-k8s
  kubernetesCluster: bs-spinnaker

stages:
  - stage:
    displayName: Deploy to QA
    jobs:
      - deployment: QA
        displayName: Deploy to QA Environment
        pool:
          vmImage: 'ubuntu-latest'
        environment: QA.azdevops
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: HelmInstaller@1
                  displayName: 'Install Helm'
                  inputs:
                    helmVersionToInstall: '$(helmVersion)'

                - task: AzureCLI@2
                  displayName: 'Add ACR to Helm Repository list'
                  inputs:
                    azureSubscription: '$(azuresubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: 'az acr helm repo add --name $(containerRegistry)'
                    failOnStandardError: false
                    
                - task: HelmDeploy@0
                  displayName: 'Helm Deploy'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscription: '$(azuresubscription)'
                    azureResourceGroup: '$(rggroup)'
                    kubernetesCluster: '$(kubernetesCluster)'
                    azureContainerRegistry: '$(containerRegistry)'
                    azureResourceGroupForACR: '$(rggroup)'
                    azureSubscriptionForACR: '$(azuresubscription)'
                    useClusterAdmin: true
                    namespace: 'azdevops'
                    command: 'upgrade'
                    chartType: 'Name'
                    chartPath: 'spinkube-chart'
                    chartName: 'spinkube-chart'
                    releaseName: '$(containerRepository)'
                    #overrideValues: 'image.repository=$(containerRegistry).azurecr.io/$(containerRepository)'
