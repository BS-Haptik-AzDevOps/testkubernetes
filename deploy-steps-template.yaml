steps:
  - checkout: self

  - task: HelmInstaller@1
    displayName: 'Install Helm'
    inputs:
      helmVersionToInstall: '$(helmVersion)'
      failOnStandardError: true

  - task: AzureCLI@2
    displayName: 'Add ACR to Helm Repository list'
    inputs:
      azureSubscription: '$(azuresubscription)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: 'az acr helm repo add --name $(containerRegistry)'
      failOnStandardError: false
                    
  - task: HelmDeploy@0
    displayName: 'Helm Deploy'
    inputs:
      connectionType: 'Azure Resource Manager'
      azureSubscription: '$(azuresubscription)'
      azureResourceGroup: '$(rggroup)'
      kubernetesCluster: '$(kubernetesCluster)'
      azureContainerRegistry: '$(containerRegistry)'
      azureResourceGroupForACR: '$(rggroup)'
      azureSubscriptionForACR: '$(azuresubscription)'
      useClusterAdmin: true
      namespace: '$(namespace)'
      command: upgrade
      chartType: Name
      chartPath: '$(chartPath)'
      chartName: $(chartName)
      releaseName: $(releaseName)
      install: true
      failOnStandardError: true
      #overrideValues: 'image.repository=$(containerRegistry).azurecr.io/$(containerRepository)'